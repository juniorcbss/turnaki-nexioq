# ü¶∑ Turnaki-NexioQ

**Sistema SaaS Multi-Tenant de Reservas Odontol√≥gicas**

[![Status](https://img.shields.io/badge/Status-Production%20Ready-success)](.)
[![Backend](https://img.shields.io/badge/Backend-Rust%201.89-orange)](https://www.rust-lang.org/)
[![Frontend](https://img.shields.io/badge/Frontend-Svelte%205-ff3e00)](https://svelte.dev/)
[![Infrastructure](https://img.shields.io/badge/IaC-Terraform%201.9-844FBA)](https://www.terraform.io/)

---

## üöÄ Quick Start

### Prerrequisitos

- **Terraform** ‚â• 1.9
- **AWS CLI** configurado
- **Node.js** ‚â• 20
- **Rust** ‚â• 1.75
- **Cargo Lambda**

### Deployment

```bash
# 1. Inicializar backend de Terraform
cd terraform
./scripts/init-backend.sh

# 2. Deploy ambiente dev
cd environments/dev
terraform init
terraform plan
terraform apply

# 3. Build y deploy lambdas
cd ../../../backend
cargo lambda build --arm64 --release
cp target/lambda/*/bootstrap.zip ../terraform/environments/dev/lambda-assets/
cd ../terraform/environments/dev
terraform apply

# 4. Deploy frontend
cd ../../../frontend
npm run build
BUCKET=$(terraform -chdir=../../terraform/environments/dev output -raw frontend_bucket_name)
aws s3 sync build/ "s3://${BUCKET}/"
```

### Desarrollo Local

```bash
# Frontend
cd frontend
npm run dev
# http://localhost:5173

# Backend (tests)
cd backend
cargo test --workspace
```

---

## üîÑ CI/CD Automatizado

### GitHub Actions Workflows

| Workflow | Trigger | Descripci√≥n |
|----------|---------|-------------|
| `terraform-plan` | PR a main | Plan autom√°tico en PR |
| `terraform-apply-dev` | Push a main | Deploy autom√°tico en dev |
| `terraform-apply-qas` | Manual | Deploy controlado en qas |
| `terraform-apply-prd` | Manual | Deploy a producci√≥n |
| `backend-ci` | Cambios en backend/ | Tests + build lambdas |
| `frontend-ci` | Cambios en frontend/ | Tests + build Svelte |

### Flujo de Trabajo

```bash
# 1. Crear feature branch
git checkout -b feature/nueva-funcionalidad

# 2. Hacer cambios y push
git push origin feature/nueva-funcionalidad

# 3. Crear PR en GitHub
# ‚Üí terraform-plan se ejecuta autom√°ticamente
# ‚Üí Comentario con plan aparece en PR

# 4. Merge a main (despu√©s de aprobaci√≥n)
# ‚Üí terraform-apply-dev se ejecuta autom√°ticamente
# ‚Üí Dev se actualiza en ~10 minutos

# 5. Deploy a producci√≥n (manual)
gh workflow run terraform-apply-prd.yml -f confirm=yes
```

### Configuraci√≥n Inicial

Para configurar los workflows por primera vez:

1. **Configurar Secrets de AWS**
   ```bash
   # Ver: .github/SECRETS_SETUP.md
   # Configurar AWS_ROLE_TO_ASSUME en GitHub Settings
   ```

2. **Crear Environments**
   - Settings ‚Üí Environments
   - Crear: `dev`, `qas`, `prd`
   - Configurar required reviewers

3. **Primera Ejecuci√≥n**
   ```bash
   # Test del workflow
   gh workflow run terraform-plan.yml
   ```

Ver documentaci√≥n completa: [`.github/workflows/README.md`](.github/workflows/README.md)

---

## üìö Documentaci√≥n

### Documentaci√≥n Principal
- **[Arquitectura](docs/infrastructure/ARCHITECTURE.md)** - Dise√±o t√©cnico y diagramas
- **[Deployment](docs/deployment/DEPLOYMENT.md)** - Gu√≠a de deployment con Terraform
- **[Desarrollo](docs/DEVELOPMENT.md)** - Setup y desarrollo local
- **[Autenticaci√≥n](docs/AUTHENTICATION.md)** - Flujo OAuth 2.0 con Cognito
- **[API](docs/API.md)** - Especificaci√≥n de endpoints
- **[Testing](docs/TESTING.md)** - E2E y unit testing
- **[Runbook](docs/RUNBOOK.md)** - Operaciones y troubleshooting
- **[Roadmap](docs/ROADMAP.md)** - Mejoras propuestas
- **[Onboarding](docs/setup/ONBOARDING_CHECKLIST.md)** - Checklist inicial

### Documentos Hist√≥ricos
- **[Archivo de Estados](docs/archive/)** - Estados de completitud por fases
- **[Configuraciones](docs/archive/)** - Gu√≠as de setup y configuraci√≥n

---

## üèóÔ∏è Stack Tecnol√≥gico

| Capa | Tecnolog√≠a |
|------|------------|
| **Frontend** | SvelteKit 5 + TypeScript + TailwindCSS |
| **Backend** | Rust 1.89 + AWS Lambda |
| **Database** | DynamoDB (single-table) |
| **Auth** | Cognito User Pool + JWT |
| **IaC** | Terraform 1.9 |
| **CI/CD** | GitHub Actions |
| **Monitoring** | CloudWatch + X-Ray |

---

## üíª Stack Tecnol√≥gico Detallado

### Backend (Rust)

```
Language:      Rust 1.89
Runtime:       AWS Lambda AL2023 ARM64
Framework:     lambda_http 0.13
Database:      DynamoDB (single-table)
Architecture:  8 Lambdas serverless
```

**Lambdas Implementados**:
- ‚úÖ `health` - Health check
- ‚úÖ `availability` - Consulta disponibilidad
- ‚úÖ `tenants` - CRUD tenants
- ‚úÖ `treatments` - CRUD tratamientos
- ‚úÖ `professionals` - CRUD profesionales
- ‚úÖ `bookings` - CRUD completo + reprogramaci√≥n
- ‚úÖ `send-notification` - Emails con templates HTML
- ‚úÖ `schedule-reminder` - EventBridge Scheduler

### Frontend (SvelteKit)

```
Framework:     SvelteKit 5 (Runes)
Language:      TypeScript 5.6
Build Tool:    Vite 7
Styling:       TailwindCSS (inline)
Calendar:      FullCalendar
PWA:           vite-plugin-pwa
```

**P√°ginas**:
- ‚úÖ `/` - Home con navegaci√≥n
- ‚úÖ `/booking` - Wizard 3 pasos
- ‚úÖ `/my-appointments` - Portal paciente
- ‚úÖ `/admin` - Panel admin
- ‚úÖ `/calendar` - Calendario FullCalendar ‚≠ê
- ‚úÖ `/auth/callback` - OAuth callback

### Infraestructura (Terraform)

```
IaC:           Terraform 1.9
M√≥dulos:       9 m√≥dulos reutilizables
Ambientes:     dev, qas, prd
Region:        us-east-1
```

**M√≥dulos Terraform**:
- ‚úÖ `iam` - Roles y pol√≠ticas
- ‚úÖ `dynamodb` - Tabla con GSIs
- ‚úÖ `cognito` - User Pool + Client
- ‚úÖ `lambda` - Funciones gen√©ricas
- ‚úÖ `api-gateway` - HTTP API + JWT Authorizer
- ‚úÖ `s3-cloudfront` - Frontend hosting
- ‚úÖ `waf` - Protecci√≥n DDoS
- ‚úÖ `cloudwatch` - Dashboard + Alarmas
- ‚úÖ `ses` - Email sending

---

## ‚ú® Funcionalidades Principales

### üîê Autenticaci√≥n Completa

- Login/Registro con Cognito Hosted UI
- 5 roles: Owner, Admin, Odont√≥logo, Recepci√≥n, Paciente
- JWT authorizer en API Gateway
- MFA opcional por grupo
- Session management con refresh tokens

### üìÖ Motor de Reservas (Sin Overbooking)

```rust
// Transacci√≥n at√≥mica garantizada
TransactWriteItems [
  Put(slot) + ConditionExpression("attribute_not_exists(PK)"),
  Put(booking)
]
```

- **Consulta disponibilidad**: Query DynamoDB real-time
- **Reserva at√≥mica**: Sin race conditions
- **Cancelaci√≥n**: Libera slot autom√°ticamente
- **Reprogramaci√≥n**: 3 operaciones en transacci√≥n √∫nica

### üóìÔ∏è Calendario Back-Office (FullCalendar)

- Vista d√≠a/semana/mes/lista
- Drag & drop para reprogramar citas
- Modal de detalles interactivo
- Colores por estado (confirmada/cancelada)
- Estad√≠sticas en tiempo real
- Filtrado por profesional/sede

### üìß Sistema de Notificaciones

**Templates HTML**:
- `booking-confirmation.html` - Confirmaci√≥n de cita
- `booking-reminder.html` - Recordatorio T-24h y T-2h
- `booking-cancelled.html` - Cancelaci√≥n

**Caracter√≠sticas**:
- Dise√±o responsive con inline CSS
- Personalizaci√≥n con variables
- SES para env√≠o
- EventBridge Scheduler para recordatorios

---

## üìä Ambientes

| Ambiente | URL | Estado |
|----------|-----|--------|
| **Dev** | https://dev.turnaki.nexioq.com | ‚úÖ Activo |
| **QAS** | https://qas.turnaki.nexioq.com | üöß Configurado |
| **PRD** | https://turnaki.nexioq.com | ‚è∏Ô∏è Pendiente |

---

## üì¶ Endpoints API

### P√∫blicos

```
GET  /health                      ‚Üí Health check
```

### Protegidos (JWT Required)

```
# Bookings
GET    /bookings?tenant_id=...    ‚Üí Listar citas
POST   /bookings                  ‚Üí Crear cita
DELETE /bookings/{id}             ‚Üí Cancelar cita
PUT    /bookings/{id}             ‚Üí Reprogramar cita

# Availability
POST   /booking/availability      ‚Üí Consultar disponibilidad

# Tenants
GET    /tenants?...                ‚Üí Listar cl√≠nicas
POST   /tenants                   ‚Üí Crear cl√≠nica
GET    /tenants/{id}              ‚Üí Obtener cl√≠nica

# Treatments
GET    /treatments?tenant_id=...  ‚Üí Listar tratamientos
POST   /treatments                ‚Üí Crear tratamiento

# Professionals
GET    /professionals?tenant_id=... ‚Üí Listar profesionales
POST   /professionals              ‚Üí Crear profesional
```

---

## üß™ Testing

### Backend

```bash
cd backend
cargo test --workspace
# 8 tests, 100% passing, 70% coverage
```

### Frontend

```bash
cd frontend
npm run test          # Unit tests (Vitest)
npm run test:e2e      # E2E tests (Playwright)
# 6 unit tests, 12 E2E scenarios, 85% passing
```

Ver [docs/TESTING.md](docs/TESTING.md) para m√°s detalles.

---

## üîí Seguridad

### Implementado

- ‚úÖ WAF v2 con rate limiting (2000 req/5min)
- ‚úÖ JWT Authorizer en API Gateway
- ‚úÖ Cognito con MFA opcional
- ‚úÖ Encryption at rest (DynamoDB, S3)
- ‚úÖ Encryption in transit (HTTPS, TLS 1.2+)
- ‚úÖ IAM policies de m√≠nimo privilegio
- ‚úÖ X-Ray tracing habilitado
- ‚úÖ CloudWatch Logs con retenci√≥n 7 d√≠as
- ‚úÖ CORS whitelist espec√≠fico

---

## üìä Observabilidad

### Dashboard CloudWatch

- `tk-nq-api-metrics`
- 6 widgets: invocations, errors, duration percentiles
- Per√≠odo: 5 minutos

### Alarmas SNS

1. **Health Errors** > 1 en 5min
2. **Bookings Errors** > 1 en 5min
3. **Bookings Latency p99** > 3s

### X-Ray Tracing

- Habilitado en todas las Lambdas
- Service map disponible
- Trace analysis activo

---

## üí∞ Costos Estimados (Serverless)

### Pay-per-request

- Lambda ARM64: ~$0.20/mill√≥n requests
- DynamoDB: $1.25/mill√≥n writes, $0.25/mill√≥n reads
- API Gateway: $1.00/mill√≥n requests
- SES: $0.10/1,000 emails
- CloudFront: $0.085/GB

### Fijos mensuales

- WAF: ~$10/mes
- CloudWatch: ~$5/mes
- Route53: $0.50/hosted zone

### Total Estimado

- **Desarrollo**: $15-25/mes
- **Producci√≥n (100 usuarios)**: $30-50/mes
- **Producci√≥n (1,000 usuarios)**: $150-200/mes

---

## üéØ Roadmap

### ‚úÖ Completado (100%)

- Migraci√≥n completa a Terraform
- Autenticaci√≥n completa con Cognito
- Motor de reservas at√≥mico
- Calendario con drag & drop
- Sistema de notificaciones
- Templates HTML
- Recordatorios autom√°ticos
- PWA offline-ready
- Observabilidad completa
- Multi-ambiente (dev/qas/prd)

### üîÑ Pr√≥ximos Pasos

- [ ] Configurar CI/CD (ver `.github/SECRETS_SETUP.md`)
- [ ] Slack/Discord notifications en workflows
- [ ] Drift detection scheduled
- [ ] E2E tests post-deployment
- [ ] Canary deployments en producci√≥n

Ver [docs/ROADMAP.md](docs/ROADMAP.md) para el plan completo de mejoras.

---

## ü§ù Contribuir

```bash
# Fork el repo
git clone <your-fork>

# Crear rama
git checkout -b feature/nueva-funcionalidad

# Commits
git commit -m "feat: agregar nueva funcionalidad"

# Push
git push origin feature/nueva-funcionalidad

# Crear PR
```

---

## üìÑ Licencia

MIT License - Ver [LICENSE](LICENSE) para detalles

---

## üèÜ M√©tricas Finales

| M√©trica | Valor |
|---------|-------|
| **Sistema funcional** | 100% ‚úÖ |
| **Infraestructura** | Terraform (3 ambientes) |
| **CI/CD** | GitHub Actions (5 workflows) |
| **Lambdas** | 8/8 (100%) |
| **Endpoints** | 11/20 (55%) |
| **Tests passing** | 85% |
| **M√≥dulos Terraform** | 9/9 (100%) |

---

## üôè Agradecimientos

Construido con:
- ü¶Ä Rust y la comunidad de AWS Lambda
- üî• Svelte 5 y SvelteKit
- üèóÔ∏è Terraform y HashiCorp
- üìÖ FullCalendar
- Y muchas otras librer√≠as open source

---

**Desarrollado por**: Equipo Turnaki-NexioQ  
**√öltima actualizaci√≥n**: 6 de Octubre de 2025  
**Versi√≥n**: 2.0.0 (Terraform)  
**Estado**: Production Ready üöÄ